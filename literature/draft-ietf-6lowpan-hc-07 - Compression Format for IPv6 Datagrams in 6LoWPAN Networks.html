<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head profile="http://dublincore.org/documents/2008/08/04/dc-html/">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="robots" content="index,follow" />
    <meta name="creator" content="rfcmarkup version 1.89" />
    <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" />
<meta name="DC.Relation.Replaces" content="draft-hui-6lowpan-hc" />
<meta name="DC.Identifier" content="urn:ietf:id:ietf-6lowpan-hc" />
<meta name="DC.Date.Issued" content="2010-04-07" />
<meta name="DC.Creator" content="Thubert, Pascal" />
<meta name="DC.Creator" content="Hui, Jonathan W." />
<meta name="DC.Description.Abstract" content="This document specifies an IPv6 header compression format for IPv6\npacket delivery in 6LoWPAN networks. The compression format relies on\nshared context to allow compression of arbitrary prefixes. How the\ninformation is maintained in that shared context is out of scope. This\ndocument specifies compression of multicast addresses and a framework\nfor compressing next headers. UDP header compression is specified\nwithin this framework." />
<meta name="DC.Title" content="Compression Format for IPv6 Datagrams in 6LoWPAN Networks" />

    <link rel="icon" href="/images/id.png" type="image/png" />
    <link rel="shortcut icon" href="/images/id.png" type="image/png" />
    <title>draft-ietf-6lowpan-hc-07 - Compression Format for IPv6 Datagrams in 6LoWPAN Networks</title>
    
    
    <style type="text/css">
	body {
	    margin: 0px 8px;
            font-size: 1em;
	}
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        @media print {
            body {
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 10.5pt;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>          <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>            <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>    <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>     <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td><td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td><td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard:</td>   <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>         <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>         <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
   <div style="height: 13px;">
      <div onmouseover="this.style.cursor='pointer';"
         onclick="showElem('legend');"
         onmouseout="hideElem('legend')"
	 style="height: 6px; position: absolute;"
         class="pre noprint docinfo bgred"
         title="Click for colour legend." >                                                                        </div>
      <div id="legend"
           class="docinfo noprint pre legend"
           style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; "
           onmouseover="showElem('legend');"
           onmouseout="hideElem('legend');">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="../html/" title="Document search and retrieval page">Docs</a>] [<a href="http://tools.ietf.org/id/draft-ietf-6lowpan-hc-07.txt" title="Plaintext version of this document">txt</a>] [<a href="/pdf/draft-ietf-6lowpan-hc-07.txt" title="PDF version of this document">pdf</a>] [<a href="../wg/6lowpan" title="The working group handling this document">WG</a>] [<a href="mailto:draft-ietf-6lowpan-hc@tools.ietf.org?subject=draft-ietf-6lowpan-hc%20" title="Send email to the document authors">Email</a>] [<a href="/rfcdiff?difftype=--hwdiff&amp;url2=draft-ietf-6lowpan-hc-07.txt" title="Inline diff (wdiff)">Diff1</a>] [<a href="/rfcdiff?url2=draft-ietf-6lowpan-hc-07.txt" title="Side-by-side diff">Diff2</a>] [<a href="/idnits?url=http://tools.ietf.org/id/draft-ietf-6lowpan-hc-07.txt" title="Run an idnits check of this document">Nits</a>]                  </span><br />
<span class="pre noprint docinfo">                                                                        </span><br />
<span class="pre noprint docinfo">Versions: (<a href="./draft-hui-6lowpan-hc" title="Precursor">draft-hui-6lowpan-hc</a>)  <a href="./draft-ietf-6lowpan-hc-00">00</a> <a href="./draft-ietf-6lowpan-hc-01">01</a> <a href="./draft-ietf-6lowpan-hc-02">02</a> <a href="./draft-ietf-6lowpan-hc-03">03</a>                           
          <a href="./draft-ietf-6lowpan-hc-04">04</a> <a href="./draft-ietf-6lowpan-hc-05">05</a> <a href="./draft-ietf-6lowpan-hc-06">06</a> <a href="./draft-ietf-6lowpan-hc-07">07</a>                                                   </span><br />
<span class="pre noprint docinfo">                                                                        </span><br />
<pre>
Network Working Group                                        J. Hui, Ed.
Internet-Draft                                     Arch Rock Corporation
Updates: <a href="./rfc4944">4944</a> (if approved)                                   P. Thubert
Intended status: Standards Track                                   Cisco
Expires: October 10, 2010                                  April 8, 2010


       <span class="h1">Compression Format for IPv6 Datagrams in 6LoWPAN Networks</span>
                        <span class="h1">draft-ietf-6lowpan-hc-07</span>

Abstract

   This document specifies an IPv6 header compression format for IPv6
   packet delivery in 6LoWPAN networks.  The compression format relies
   on shared context to allow compression of arbitrary prefixes.  How
   the information is maintained in that shared context is out of scope.
   This document specifies compression of multicast addresses and a
   framework for compressing next headers.  UDP header compression is
   specified within this framework.

Status of this Memo

   This Internet-Draft is submitted in full conformance with the
   provisions of <a href="./bcp78">BCP 78</a> and <a href="./bcp79">BCP 79</a>.

   Internet-Drafts are working documents of the Internet Engineering
   Task Force (IETF).  Note that other groups may also distribute
   working documents as Internet-Drafts.  The list of current Internet-
   Drafts is at <a href="http://datatracker.ietf.org/drafts/current/">http://datatracker.ietf.org/drafts/current/</a>.

   Internet-Drafts are draft documents valid for a maximum of six months
   and may be updated, replaced, or obsoleted by other documents at any
   time.  It is inappropriate to use Internet-Drafts as reference
   material or to cite them other than as "work in progress."

   This Internet-Draft will expire on October 10, 2010.

Copyright Notice

   Copyright (c) 2010 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="./bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must



<span class="grey">Hui &amp; Thubert           Expires October 10, 2010                [Page 1]</span>
</pre><pre class='newpage'><a name="page-2" id="page-2" href="#page-2" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


   include Simplified BSD License text as described in <a href="#section-4">Section 4</a>.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.


Table of Contents

   <a href="#section-1">1</a>.  Introduction . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-3">3</a>
     <a href="#section-1.1">1.1</a>.  Requirements Language  . . . . . . . . . . . . . . . . . .  <a href="#page-4">4</a>
   <a href="#section-2">2</a>.  Specific Updates to <a href="./rfc4944">RFC 4944</a> . . . . . . . . . . . . . . . . .  <a href="#page-4">4</a>
   <a href="#section-3">3</a>.  IPv6 Header Compression  . . . . . . . . . . . . . . . . . . .  <a href="#page-5">5</a>
     <a href="#section-3.1">3.1</a>.  LOWPAN_IPHC Encoding Format  . . . . . . . . . . . . . . .  <a href="#page-6">6</a>
       <a href="#section-3.1.1">3.1.1</a>.  Base Format  . . . . . . . . . . . . . . . . . . . . .  <a href="#page-6">6</a>
       <a href="#section-3.1.2">3.1.2</a>.  Context Identifier Extension . . . . . . . . . . . . .  <a href="#page-8">8</a>
     <a href="#section-3.2">3.2</a>.  IPv6 Header Encoding . . . . . . . . . . . . . . . . . . .  <a href="#page-9">9</a>
       <a href="#section-3.2.1">3.2.1</a>.  Traffic Class and Flow Label Compression . . . . . . .  <a href="#page-9">9</a>
       <a href="#section-3.2.2">3.2.2</a>.  Mapping Link-Layer Addresses to Interface IDs  . . . . <a href="#page-10">10</a>
       <a href="#section-3.2.3">3.2.3</a>.  Stateless Multicast Addresses Compression  . . . . . . <a href="#page-11">11</a>
       <a href="#section-3.2.4">3.2.4</a>.  Stateful Multicast Addresses Compression . . . . . . . <a href="#page-12">12</a>
   <a href="#section-4">4</a>.  IPv6 Next Header Compression . . . . . . . . . . . . . . . . . <a href="#page-13">13</a>
     <a href="#section-4.1">4.1</a>.  LOWPAN_NHC Format  . . . . . . . . . . . . . . . . . . . . <a href="#page-13">13</a>
     <a href="#section-4.2">4.2</a>.  IPv6 Extension Header Compression  . . . . . . . . . . . . <a href="#page-14">14</a>
     <a href="#section-4.3">4.3</a>.  UDP Header Compression . . . . . . . . . . . . . . . . . . <a href="#page-15">15</a>
       <a href="#section-4.3.1">4.3.1</a>.  Compressing UDP ports  . . . . . . . . . . . . . . . . <a href="#page-15">15</a>
       <a href="#section-4.3.2">4.3.2</a>.  Compressing UDP checksum . . . . . . . . . . . . . . . <a href="#page-16">16</a>
       <a href="#section-4.3.3">4.3.3</a>.  UDP LOWPAN_NHC Format  . . . . . . . . . . . . . . . . <a href="#page-16">16</a>
   <a href="#section-5">5</a>.  IANA Considerations  . . . . . . . . . . . . . . . . . . . . . <a href="#page-17">17</a>
   <a href="#section-6">6</a>.  Security Considerations  . . . . . . . . . . . . . . . . . . . <a href="#page-18">18</a>
   <a href="#section-7">7</a>.  Acknowledgements . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-18">18</a>
   <a href="#section-8">8</a>.  Changes  . . . . . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-18">18</a>
   <a href="#section-9">9</a>.  References . . . . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-19">19</a>
     <a href="#section-9.1">9.1</a>.  Normative References . . . . . . . . . . . . . . . . . . . <a href="#page-19">19</a>
     <a href="#section-9.2">9.2</a>.  Informative References . . . . . . . . . . . . . . . . . . <a href="#page-20">20</a>
   Authors' Addresses . . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-21">21</a>

















<span class="grey">Hui &amp; Thubert           Expires October 10, 2010                [Page 2]</span>
</pre><pre class='newpage'><a name="page-3" id="page-3" href="#page-3" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


<span class="h2"><a name="section-1">1</a>.  Introduction</span>

   The [IEEE 802.15.4] standard specifies an MTU of 128 bytes, yielding
   about 80 octets of actual MAC payload with security enabled, on a
   wireless link with a link throughput of 250 kbps or less.  The
   6LoWPAN adaptation format [<a href="./rfc4944" title='"Transmission of IPv6 Packets over IEEE 802.15.4 Networks"'>RFC4944</a>] was specified to carry IPv6
   datagrams over such constrained links, taking into account limited
   bandwidth, memory, or energy resources that are expected in
   applications such as wireless sensor networks.  [<a href="./rfc4944" title='"Transmission of IPv6 Packets over IEEE 802.15.4 Networks"'>RFC4944</a>] defines a
   Mesh Addressing header to support sub-IP forwarding, a Fragmentation
   header to support the IPv6 minimum MTU requirement [<a href="./rfc2460" title='"Internet Protocol, Version 6 (IPv6) Specification"'>RFC2460</a>], and
   stateless header compression for IPv6 datagrams (LOWPAN_HC1 and
   LOWPAN_HC2) to reduce the relatively large IPv6 and UDP headers down
   to (in the best case) several bytes.

   LOWPAN_HC1 and LOWPAN_HC2 are insufficient for most practical uses of
   6LoWPAN networks.  LOWPAN_HC1 is most effective for link-local
   unicast communication, where IPv6 addresses carry the link-local
   prefix and an Interface Identifier (IID) directly derived from IEEE
   802.15.4 addresses.  In this case, both addresses may be completely
   elided.  However, though link-local addresses are commonly used for
   local protocol interactions such as IPv6 ND [<a href="./rfc4861" title='"Neighbor Discovery for IP version 6 (IPv6)"'>RFC4861</a>], DHCPv6
   [<a href="./rfc3315" title='"Dynamic Host Configuration Protocol for IPv6 (DHCPv6)"'>RFC3315</a>] or routing protocols, they are usually not used for
   application-layer data traffic, so the actual value of this
   compression mechanism is limited.

   Routable addresses must be used when communicating with devices
   external to the LoWPAN or in a route-over configuration where IP
   forwarding occurs within the LoWPAN.  For routable addresses,
   LOWPAN_HC1 requires both IPv6 source and destination addresses to
   carry the prefix in-line.  In cases where the Mesh Addressing header
   is not used, the IID of a routable address must be carried in-line.
   However, LOWPAN_HC1 requires 64-bits for the IID when carried in-line
   and cannot be shortened even when it is derived from the IEEE
   802.15.4 16-bit short address.  When the destination is an IPv6
   multicast address, LOWPAN_HC1 requires the full 128-bit address to be
   carried in-line.

   As a result, this document defines an encoding format, LOWPAN_IPHC,
   for effective compression of Unique Local, Global, and multicast IPv6
   Addresses based on shared state within contexts.  In addition, this
   document also introduces a number of additional improvements over the
   header compression format defined in [<a href="./rfc4944" title='"Transmission of IPv6 Packets over IEEE 802.15.4 Networks"'>RFC4944</a>].

   LOWPAN_IPHC allows for compression of some commonly-used IPv6 Hop
   Limit values.  If the LoWPAN is a mesh-under stub, a Hop Limit of 1
   for inbound and a default value such as 64 for outbound are usually
   enough for application layer data traffic.  Additionally, a hop-limit



<span class="grey">Hui &amp; Thubert           Expires October 10, 2010                [Page 3]</span>
</pre><pre class='newpage'><a name="page-4" id="page-4" href="#page-4" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


   value of 255 is often used to verify that a communication occurs over
   a single-hop.  This specification enables compression of the IPv6 Hop
   Limit field in those common cases, whereas LOWPAN_HC1 does not.

   This document also defines LOWPAN_NHC, an encoding format for
   arbitrary next headers.  LOWPAN_IPHC indicates whether the following
   header is encoded using LOWPAN_NHC.  If so, the bits immediately
   following the compressed IPv6 header start the LOWPAN_NHC encoding.
   In contrast, LOWPAN_HC1 could be extended to support compression of
   next headers using LOWPAN_HC2, but only for UDP, TCP, and ICMPv6.
   Furthermore, the LOWPAN_HC2 octet sits between the LOWPAN_HC1 octet
   and uncompressed IPv6 header fields.  This specification moves the
   next header encoding bits to follow all IPv6-related bits, allowing
   for a properly layered structure and direct support for IPv6
   extension headers.

   Using LOWPAN_NHC, this document defines a compression mechanism for
   UDP.  While [<a href="./rfc4944" title='"Transmission of IPv6 Packets over IEEE 802.15.4 Networks"'>RFC4944</a>] defines a compression mechanism for UDP, that
   mechanism does not enable checksum compression when rendered possible
   by additional upper layer mechanisms such as upper layer Message
   Integrity Check (MIC).  This specification adds the capability to
   elide the UDP checksum over the LoWPAN, which enables saving of a
   further two octets.

   Also using LOWPAN_NHC, this document defines encoding formats for
   IPv6-in-IPv6 encapsulation as well as IPv6 Extension Headers.  With
   LOWPAN_HC1 and LOWPAN_HC2, chains of next headers cannot be encoded
   efficiently.

<span class="h3"><a name="section-1.1">1.1</a>.  Requirements Language</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <a href="./rfc2119">RFC 2119</a> [<a href="./rfc2119" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>].


<span class="h2"><a name="section-2">2</a>.  Specific Updates to <a href="./rfc4944">RFC 4944</a></span>

   This document specifies a header compression format that is intended
   to replace that defined in <a href="./rfc4944#section-10">Section&nbsp;10 of [RFC4944]</a>.  Implementation
   of <a href="./rfc4944#section-10">Section&nbsp;10 of [RFC4944]</a> is now NOT RECOMMENDED.  New
   implementations MAY implement compression according to <a href="./rfc4944#section-10">Section&nbsp;10 of
   [RFC4944]</a>, but SHOULD NOT send packets compressed according to
   <a href="./rfc4944#section-10">Section&nbsp;10 of [RFC4944]</a>.

   <a href="./rfc4944#section-5.3">Section&nbsp;5.3 of [RFC4944]</a> also defines how to fragment compressed IPv6
   datagrams that do not fit within a single link frame.  <a href="./rfc4944#section-5.3">Section&nbsp;5.3 of
   [RFC4944]</a> defines the fragment header's datagram_size and



<span class="grey">Hui &amp; Thubert           Expires October 10, 2010                [Page 4]</span>
</pre><pre class='newpage'><a name="page-5" id="page-5" href="#page-5" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


   datagram_offset values as the size and offset of the IPv6 datagram
   before compression.  As a result, all fragment payload outside the
   first fragment must carry their respective portions of the IPv6
   datagram before compression.  This document does not change that
   requirement.  When using the fragmentation mechanism described in
   <a href="./rfc4944#section-5.3">Section&nbsp;5.3 of [RFC4944]</a>, any header that cannot fit within the first
   fragment MUST NOT be compressed.

   The header compression format defined in this document preempts the
   ESC dispatch value defined in <a href="./rfc4944#section-5.1">Section&nbsp;5.1 of [RFC4944]</a>.  Instead, the
   value of 01 000000 is reserved as a replacement value for ESC, to be
   finally assigned with the first assignment of extension bytes.


<span class="h2"><a name="section-3">3</a>.  IPv6 Header Compression</span>

   In this section, we define the LOWPAN_IPHC encoding format for
   compressing the IPv6 header.  To enable effective compression
   LOWPAN_IPHC relies on information pertaining to the entire 6LoWPAN
   network.  LOWPAN_IPHC assumes the following will be the common case
   for 6LoWPAN communication: Version is 6; Traffic Class and Flow Label
   are both zero; Payload Length can be inferred from lower layers from
   either the 6LoWPAN Fragmentation header or the IEEE 802.15.4 header;
   Hop Limit will be set to a well-known value by the source; addresses
   assigned to 6LoWPAN interfaces will be formed using the link-local
   prefix or a small set of routable prefixes assigned to the entire
   6LoWPAN network; addresses assigned to 6LoWPAN interfaces are formed
   with an IID derived directly from either the 64-bit extended or 16-
   bit short IEEE 802.15.4 addresses.


    +-------------------------------------+----------------------------
    | Dispatch + LOWPAN_IPHC (2-3 octets) | In-line IPv6 Header Fields
    +-------------------------------------+----------------------------


                       Figure 1: LOWPAN_IPHC Header

   The LOWPAN_IPHC encoding utilizes 13 bits, 5 of which are taken from
   the rightmost bit of the dispatch type.  The encoding may be extended
   by another octet to support additional contexts.  Any information
   from the uncompressed IPv6 header fields carried in-line follow the
   LOWPAN_IPHC encoding, as shown in Figure 1.  In the best case, the
   LOWPAN_IPHC can compress the IPv6 header down to two octets (the
   dispatch octet and the LOWPAN_IPHC encoding) with link-local
   communication.

   When routing over multiple IP hops, LOWPAN_IPHC can compress the IPv6



<span class="grey">Hui &amp; Thubert           Expires October 10, 2010                [Page 5]</span>
</pre><pre class='newpage'><a name="page-6" id="page-6" href="#page-6" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


   header down to 7 octets (1-octet dispatch, 1-octet LOWPAN_IPHC,
   1-octet Hop Limit, 2-octet Source Address, and 2-octet Destination
   Address).  The Hop Limit may not be compressed because it needs to
   decremented at each hop and may take any value.  Stateful address
   compression must be applied to the source and destination IPv6
   addresses because they do not statelessly match the source and
   destination link layer addresses on intermediate hops.

<span class="h3"><a name="section-3.1">3.1</a>.  LOWPAN_IPHC Encoding Format</span>

   This section specifies the format of the LOWPAN_IPHC encoding that
   describes how an IPv6 header is compressed.  The encoding can be 2
   octets long for the base encoding or 3 octets long when an additional
   context encoding is present.  The IPv6 header fields that are not
   fully elided are placed immediately after the LOWPAN_IPHC, either in
   a compressed form if the field is partially elided, or literally.

<span class="h4"><a name="section-3.1.1">3.1.1</a>.  Base Format</span>


       0   1   2   3   4   5   6   7   8   9   0   1   2   3   4   5
     +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
     | 0 | 1 | 1 |  TF   |NH | HLIM  |CID|SAC|  SAM  | M |DAC|  DAM  |
     +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+


                    Figure 2: LOWPAN_IPHC base Encoding

   TF: Traffic Class, Flow Label:
      00:  ECN + DSCP + 4-bit Pad + Flow Label (4 bytes)
      01:  ECN + 2-bit Pad + Flow Label (3 bytes), DSCP is elided
      10:  ECN + DSCP (1 byte), Flow Label is elided
      11:  Traffic Class and Flow Label are elided.

   NH: Next Header:
      0: Full 8 bits for Next Header are carried in-line.
      1: The Next Header field is compressed and the next header is
         encoded using LOWPAN_NHC, which is discussed in <a href="#section-4">Section 4</a>.

   HLIM: Hop Limit:
      00:  The Hop Limit field is carried in-line.
      01:  The Hop Limit field is compressed and the hop limit is 1.
      10:  The Hop Limit field is compressed and the hop limit is 64.
      11:  The Hop Limit field is compressed and the hop limit is 255.







<span class="grey">Hui &amp; Thubert           Expires October 10, 2010                [Page 6]</span>
</pre><pre class='newpage'><a name="page-7" id="page-7" href="#page-7" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>



   CID: Context Identifier Extension:
      0: No additional 8-bit Context Identifier Extension is used.  If
         context-based compression is specified in either SAC or DAC,
         context 0 is used.
      1: An additional 8-bit Context Identifier Extension field
         immediately follows the DAM field.

   SAC: Source Address Compression
      0: Source address compression uses stateless compression.
      1: Source address compression uses stateful, context-based
         compression.

   SAM: Source Address Mode:
      If SAC=0:
         00:  128 bits.  The full address is carried in-line.
         01:  64 bits.  The first 64-bits of the address are elided.
            The value of those bits is the link-local prefix padded with
            zeros.  The remaining 64 bits are carried in-line.
         10:  16 bits.  The first 112 bits of the address are elided.
            The value of those bits is the link-local prefix padded with
            zeros.  The remaining 16 bits are carried in-line.
         11:  0 bits.  The address is fully elided.  The first 64 bits
            of the address are the link-local prefix padded with zeros.
            The remaining 64 bits are computed from the link-layer
            address as defined in <a href="#section-3.2.2">Section 3.2.2</a>.
      If SAC=1:
         00:  The UNSPECIFIED address, ::
         01:  64 bits.  The address is derived using context information
            and the 64 bits carried in-line.
         10:  16 bits.  The address is derived using context information
            and the 16 bits carried in-line.
         11:  0 bits.  The address is fully elided.  The prefix is
            derived using context information.  Any of the remaining 64
            bits not covered by the context information are computed
            from the link-layer address as defined in <a href="#section-3.2.2">Section 3.2.2</a>.

   M: Multicast Compression
      0: Destination address is not a multicast address.
      1: Destination address is a multicast address.

   DAC: Destination Address Compression
      0: Destination address compression uses stateless compression.
      1: Destination address compression uses stateful, context-based
         compression.






<span class="grey">Hui &amp; Thubert           Expires October 10, 2010                [Page 7]</span>
</pre><pre class='newpage'><a name="page-8" id="page-8" href="#page-8" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>



   DAM: Destination Address Mode:
      If M=0 and DAC=0  This case matches SAC=0 but for the destination
         address:
         00:  128 bits.  The full address is carried in-line.
         01:  64 bits.  The first 64-bits of the address are elided.
            The value of those bits is the link-local prefix padded with
            zeros.  The remaining 64 bits are carried in-line.
         10:  16 bits.  The first 112 bits of the address are elided.
            The value of those bits is the link-local prefix padded with
            zeros.  The remaining 16 bits are carried in-line.
         11:  0 bits.  The address is fully elided.  The first 64 bits
            of the address are the link-local prefix padded with zeros.
            The remaining 64 bits are computed from the link-layer
            address as defined in <a href="#section-3.2.2">Section 3.2.2</a>.
      If M=0 and DAC=1:
         00:  Reserved.
         01:  64 bits.  The address is derived using context information
            and the 64 bits carried in-line.
         10:  16 bits.  The address is derived using context information
            and the 16 bits carried in-line.
         11:  0 bits.  The address is fully elided.  The prefix is
            derived using context information.  Any of the remaining 64
            bits not covered by the context information are computed
            from the link-layer address as defined in <a href="#section-3.2.2">Section 3.2.2</a>.
      If M=1 and DAC=0:
         00:  128 bits.  The full address is carried in-line.
         01:  48 bits.  The address takes the form FFXX::00XX:XXXX:XXXX.
         10:  32 bits.  The address takes the form FFXX::00XX:XXXX.
         11:  8 bits.  The address takes the form FF02::00XX.
      If M=1 and DAC=1:
         00:  48 bits.  This format is designed to match Unicast-Prefix-
            based IPv6 Multicast Addresses as defined in [<a href="./rfc3306" title='"Unicast-Prefix-based IPv6 Multicast Addresses"'>RFC3306</a>] and
            [<a href="./rfc3956" title='"Embedding the Rendezvous Point (RP) Address in an IPv6 Multicast Address"'>RFC3956</a>].  The multicast address takes the form FFXX:XXLL:
            PPPP:PPPP:PPPP:PPPP:XXXX:XXXX. where the X are the nibbles
            that are carried in-line, in the order in which they appear
            in this format.  P denotes nibbles used to encode the prefix
            itself.  L denotes nibbles used to encode the prefix length.
            The prefix information P and L is taken from the specified
            context.
         01:  reserved
         10:  reserved
         11:  reserved

<span class="h4"><a name="section-3.1.2">3.1.2</a>.  Context Identifier Extension</span>

   This specification expects that a conceptual context is shared
   between the node that compresses a packet and the node(s) that need



<span class="grey">Hui &amp; Thubert           Expires October 10, 2010                [Page 8]</span>
</pre><pre class='newpage'><a name="page-9" id="page-9" href="#page-9" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


   to expand it.  How the contexts are shared and maintained is out of
   scope.  What information is contained within a context information is
   out of scope.  Actions in response to unknown and/or invalid contexts
   are out of scope.  The specification enables a node to use up to 16
   contexts.  The context used to encode the source address does not
   have to be the same as the context used to encode the destination
   address.

   If the CID field is set to '1' in the LOWPAN_IPHC encoding, then an
   additional octet extends the LOWPAN_IPHC encoding following the DAM
   bits but before the IPv6 header fields that are carried in-line.  The
   additional octet identifies the pair of contexts to be used when the
   IPv6 source and/or destination address is compressed.  The context
   identifier is 4 bits for each address, supporting up to 16 contexts.
   Context 0 is the default context.  The encoding is shown in Figure 3.


                       0   1   2   3   4   5   6   7
                     +---+---+---+---+---+---+---+---+
                     |      SCI      |      DCI      |
                     +---+---+---+---+---+---+---+---+


                      Figure 3: LOWPAN_IPHC Encoding

   SCI: Source Context Identifier  Identifies the prefix that is used
      when the IPv6 source address is statefully compressed.
   DCI: Destination Context Identifier  Identifies the prefix that is
      used when the IPv6 destination address is statefully compressed.

<span class="h3"><a name="section-3.2">3.2</a>.  IPv6 Header Encoding</span>

   Fields carried in-line (in part or in whole) appear in the same order
   as they do in the IPv6 header format [<a href="./rfc2460" title='"Internet Protocol, Version 6 (IPv6) Specification"'>RFC2460</a>].  The Version field is
   always elided.  Unicast IPv6 addresses may be compressed to 64 or 16
   bits or completely elided.  Multicast IPv6 addresses may be
   compressed to 8, 32, or 48 bits.  The IPv6 Payload Length field MUST
   always be elided and inferred from lower layers using the 6LoWPAN
   Fragmentation header or the IEEE 802.15.4 header.

<span class="h4"><a name="section-3.2.1">3.2.1</a>.  Traffic Class and Flow Label Compression</span>

   The Traffic Class field in the IPv6 header comprises 6 bits of
   diffserv extension [<a href="./rfc2474" title='"Definition of the Differentiated Services Field (DS Field) in the IPv4 and IPv6 Headers"'>RFC2474</a>] and 2 bits of Explicit Congestion
   Notification (ECN) [<a href="./rfc3168" title='"The Addition of Explicit Congestion Notification (ECN) to IP"'>RFC3168</a>].  If the ECN information is carried by
   the Lower Layers in a compatible fashion then it can be elided from
   the 6LoWPAN header.  Otherwise, it has to be transported in one of
   the following encodings.



<span class="grey">Hui &amp; Thubert           Expires October 10, 2010                [Page 9]</span>
</pre><pre class='newpage'><a name="page-10" id="page-10" href="#page-10" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


   The TF field in the LOWPAN_IPHC encoding indicates whether the
   Traffic Class and Flow Label are carried in-line in the compressed
   IPv6 header.  When Flow Label is included while the Traffic Class is
   compressed, an additional 4 bits are included to maintain byte-
   alignment.  Two of the 4 bits contain the ECN bits from the Traffic
   Class field.

   To ensure that the ECN bits appear in the same location for all
   encodings that include them, the Traffic Class field is rotated right
   by 2 bits in the compressed IPv6 header.  The encodings are shown
   below:


                          1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |ECN|   DSCP    |  rsv  |             Flow Label                |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


          TF = 00: Traffic Class and Flow Label carried in-line.



                          1                   2
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |ECN|rsv|             Flow Label                |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


                   TF = 01: Flow Label carried in-line.



      0 1 2 3 4 5 6 7
     +-+-+-+-+-+-+-+-+
     |ECN|   DSCP    |
     +-+-+-+-+-+-+-+-+


                  TF = 10: Traffic Class carried in-line.

<span class="h4"><a name="section-3.2.2">3.2.2</a>.  Mapping Link-Layer Addresses to Interface IDs</span>

   LOWPAN_IPHC elides the IIDs of source or destination addresses when
   SAM = 3 or DAM = 3, respectively.  This section defines the mapping
   from IEEE 802.15.4 link-layer addresses to IIDs for both short and



<span class="grey">Hui &amp; Thubert           Expires October 10, 2010               [Page 10]</span>
</pre><pre class='newpage'><a name="page-11" id="page-11" href="#page-11" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


   extended IEEE 802.15.4 addresses.  IID bits not covered by the
   context information MAY be elided if they match the link-layer
   address mapping and MUST NOT be elided if they do not.

   An extended IEEE 802.15.4 address takes the form of an IEEE EUI-64
   address.  Generating an IID from an extended address is identical to
   that defined in <a href="#appendix-A">Appendix A</a> of [<a href="./rfc4291" title='"IP Version 6 Addressing Architecture"'>RFC4291</a>].  The only change needed to
   transform an IEEE EUI-64 identifier to an interface identifier is to
   invert the universal/local bit.

   A short IEEE 802.15.4 address is 16 bits in length.  Short addresses
   are mapped into the restricted space of IEEE EUI-64 addresses by
   setting the middle 16 bits to 0xfffe, the bottom 16 bits to the short
   address, and all other bits to zero.  As a result, an IID generated
   from a short address has the form:

      0000:00ff:fe00:XXXX

   where XXXX carries the short address.  The universal/local bit is
   zero to indicate local scope.

   This mapping for non-EUI-64 identifiers differs from that presented
   in <a href="#appendix-A">Appendix A</a> of [<a href="./rfc4291" title='"IP Version 6 Addressing Architecture"'>RFC4291</a>] for a couple reasons.  Using the
   restricted space ensures no overlap with IIDs generated from
   unrestricted IEEE EUI-64 addresses.  Also, including 0xfffe in the
   middle of the IID helps avoid overlap with other locally managed
   IIDs.

<span class="h4"><a name="section-3.2.3">3.2.3</a>.  Stateless Multicast Addresses Compression</span>

   LOWPAN_IPHC supports stateless compression of multicast address when
   M = 1 and DAC = 0.  An IPv6 multicast address may be compressed down
   to 48, 32, or 8 bits using stateless compression.  The format
   supports compression of the Solicited-Node Multicast Address (FF02::
   1:FFXX:XXXX) as well as any IPv6 multicast address where the upper
   bits of the multicast group identifier are zero.  The 8-bit
   compressed form only carries the least-significant bits of the
   multicast group identifier.  The 48 and 32-bit compressed forms carry
   the multicast scope and flags in-line, in addition to the least-
   significant bits of the multicast group identifier.


                          1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     | Flags | Scope |              Group Identifier                 |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |        Group Identifier       |



<span class="grey">Hui &amp; Thubert           Expires October 10, 2010               [Page 11]</span>
</pre><pre class='newpage'><a name="page-12" id="page-12" href="#page-12" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


   DAM = 01. 48-bit Compressed Multicast Address (FFfs::00gg:gggg:gggg)



                          1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     | Flags | Scope |              Group Identifier                 |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


     DAM = 10. 32-bit Compressed Multicast Address (FFfs::00gg:gggg).




      0 1 2 3 4 5 6 7
     +-+-+-+-+-+-+-+-+
     |   Group ID    |
     +-+-+-+-+-+-+-+-+


         DAM = 11. 8-bit Compressed Multicast Address (FF02::gg).

<span class="h4"><a name="section-3.2.4">3.2.4</a>.  Stateful Multicast Addresses Compression</span>

   LOWPAN_IPHC supports stateful compression of multicast addresses when
   M = 1 and DAC = 1.  This document currently defines DAM = 00:
   context-based compression of Unicast-Prefix-based IPv6 Multicast
   Addresses [<a href="./rfc3306" title='"Unicast-Prefix-based IPv6 Multicast Addresses"'>RFC3306</a>][RFC3956].  In particular, the Prefix Length and
   Network Prefix can be taken from a context.  As a result, LOWPAN_IPHC
   can compress a Unicast-Prefix-based IPv6 Multicast Address down to 6
   octets by only carrying the 4-bit Flags, 4-bit Scope, 8-bit RIID, and
   32-bit Group Identifier in-line.


                          1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     | Flags | Scope | Rsvd / RIID   |       Group Identifier        |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |        Group Identifier       |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+





<span class="grey">Hui &amp; Thubert           Expires October 10, 2010               [Page 12]</span>
</pre><pre class='newpage'><a name="page-13" id="page-13" href="#page-13" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


     DAM = 01. Unicast-Prefix-based IPv6 Multicast Address Compression

   Note that the Reserved field MUST carry the reserved bits from the
   multicast address format as described in [<a href="./rfc3306" title='"Unicast-Prefix-based IPv6 Multicast Addresses"'>RFC3306</a>].  When a
   Rendezvous Point is encoded in the multicast address as described in
   [<a href="./rfc3956" title='"Embedding the Rendezvous Point (RP) Address in an IPv6 Multicast Address"'>RFC3956</a>], the Reserved field carries the RIID bits in-line.


<span class="h2"><a name="section-4">4</a>.  IPv6 Next Header Compression</span>

   LOWPAN_IPHC elides the IPv6 Next Header field when the NH bit is set
   to 1.  It also indicates the use of 6LoWPAN next header compression,
   LOWPAN_NHC.  The value of IPv6 Next Header is recovered from the
   first bits in the LOWPAN_NHC encoding.  The following bits are
   specific to the IPv6 Next Header value.  Figure 4 shows the structure
   of an IPv6 datagram compressed using LOWPAN_IPHC and LOWPAN_NHC.


   +-------------+-------------+-------------+-----------------+--------
   | LOWPAN_IPHC | In-line     | LOWPAN_NHC  | In-line Next    | Payload
   |   Encoding  |   IP Fields |   Encoding  |   Header Fields |
   +-------------+-------------+-------------+-----------------+--------


       Figure 4: Typical LOWPAN_IPHC/LOWPAN_NHC Header Configuration

<span class="h3"><a name="section-4.1">4.1</a>.  LOWPAN_NHC Format</span>

   Compression formats for different next headers are identified by a
   variable-length bit-pattern immediately following the LOWPAN_IPHC
   compressed header.  When defining a next header compression format,
   the number of bits used SHOULD be determined by the perceived
   frequency of using that format.  However, the number of bits and any
   remaining encoding bits SHOULD respect octet alignment.  The
   following bits are specific to the next header compression format.
   This document defines a compression format for IPv6 Extension and UDP
   headers.


               +----------------+---------------------------
               | var-len NHC ID | compressed next header...
               +----------------+---------------------------


                       Figure 5: LOWPAN_NHC Encoding






<span class="grey">Hui &amp; Thubert           Expires October 10, 2010               [Page 13]</span>
</pre><pre class='newpage'><a name="page-14" id="page-14" href="#page-14" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


<span class="h3"><a name="section-4.2">4.2</a>.  IPv6 Extension Header Compression</span>

   A necessary property of encoding headers using LOWPAN_NHC is that the
   immediately preceding header must either be encoded using LOWPAN_IPHC
   or LOWPAN_NHC.  In other words, all headers encoded using the 6LoWPAN
   encoding format defined in this document must be contiguous.  As a
   result, this document defines a set of LOWPAN_NHC encodings for
   selected IPv6 Extension Headers such that the UDP Header Compression
   defined in <a href="#section-4.3">Section 4.3</a> may be used in the presence of those extension
   headers.

   The LOWPAN_NHC encodings for IPv6 Extension Headers are composed of a
   single LOWPAN_NHC octet followed by the IPv6 Extension Header.  The
   format of the LOWPAN_NHC octet is shown in Figure 6.  The first 7
   bits serve as an identifier for the IPv6 Extension Header immediately
   following the LOWPAN_NHC octet.  The remaining bit indicates whether
   or not the following header utilizes LOWPAN_NHC encoding.


                       0   1   2   3   4   5   6   7
                     +---+---+---+---+---+---+---+---+
                     | 1 | 1 | 1 | 0 |    EID    |NH |
                     +---+---+---+---+---+---+---+---+


                 Figure 6: IPv6 Extension Header Encoding

   EID: IPv6 Extension Header ID:
      0: IPv6 Hop-by-Hop Options Header[RFC2460]
      1: IPv6 Routing Header[RFC2460]
      2: IPv6 Fragment Header[RFC2460]
      3: IPv6 Destination Options Header[RFC2460]
      4: IPv6 Mobility Header [<a href="./rfc3775" title='"Mobility Support in IPv6"'>RFC3775</a>]
      5: Reserved
      6: Reserved
      7: IPv6 Header

   NH: Next Header:
      0: Full 8 bits for Next Header are carried in-line.
      1: The Next Header field is elided and the next header is encoded
         using LOWPAN_NHC, which is discussed in <a href="#section-4">Section 4</a>.

   For the most part, the IPv6 Extension Header is carried verbatim in
   the bytes immediately following the LOWPAN_NHC octet, with two
   important exceptions: Length Field and Next Header Field.

   The Next Header Field contained in IPv6 Extension Headers is elided
   when the NH bit is set in the LOWPAN_NHC encoding octet.  Note that



<span class="grey">Hui &amp; Thubert           Expires October 10, 2010               [Page 14]</span>
</pre><pre class='newpage'><a name="page-15" id="page-15" href="#page-15" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


   doing so allows LOWPAN_NHC to utilize no more overhead than the non-
   encoded IPv6 Extension Header.

   The Length Field contained in IPv6 Extension Headers indicate the
   length of the IPv6 Extension Header in octets, not including the
   LOWPAN_NHC byte.  Note that this changes the Length Field definition
   in [<a href="./rfc2460" title='"Internet Protocol, Version 6 (IPv6) Specification"'>RFC2460</a>] from indicating the header size in 8-octet units, not
   including the first 8 octets.  Changing the Length Field to be in
   units of octets removes wasteful internal fragmentation.  However,
   specifying units in octets also means that LOWPAN_NHC MUST NOT be
   used to encode IPv6 Extension Headers that exceed 255 octets.

   IPv6 Hop-by-Hop and Destination Options Headers may use Pad1 and PadN
   to pad out the header for octet-alignment purposes.  When using
   LOWPAN_NHC, Pad1 and PadN options that appear at the end of the
   options header MAY be elided.  When converting from the LOWPAN_NHC
   encoding back to the standard IPv6 encoding, Pad1 and PadN options
   MUST be used to pad out the containing header to a multiple of 8
   octets in length.  Note that Pad1 and PadN options that appear in
   locations other than the end MUST be carried in-line as they are used
   to align subsequent options.

   When the identified next header is an IPv6 Header (EID=7), the NH bit
   of the LOWPAN_NHC encoding is unused and SHOULD be set to zero.  The
   following bytes MUST be encoded using LOWPAN_IPHC as defined in
   <a href="#section-3">Section 3</a>.

<span class="h3"><a name="section-4.3">4.3</a>.  UDP Header Compression</span>

   This document defines a compression format for UDP headers using
   LOWPAN_NHC.  The UDP compression format is shown in Figure 7.  Bits 0
   through 4 represent the NHC ID and '11110' indicates the specific UDP
   header compression encoding defined in this section.

<span class="h4"><a name="section-4.3.1">4.3.1</a>.  Compressing UDP ports</span>

   This specification introduces a range of well-known ports (0xF0Bx)
   that can be compressed to 4 bits.  Considering that this represents
   only 16 contiguous ports, it can be expected that many incompatible
   applications will use the same port numbers for their own end-to-end
   needs.

   The overloading of the 0xF0Bx ports increases the risk of getting the
   wrong type of payload and misinterpreting the content compared to
   ports that are reserved at IANA.  As a result, it is recommended that
   the use of those ports be associated with a mechanism such as a
   Transport Layer Security (TLS) Message Integrity Check (MIC) that
   validates that the content is expected and checked for integrity.



<span class="grey">Hui &amp; Thubert           Expires October 10, 2010               [Page 15]</span>
</pre><pre class='newpage'><a name="page-16" id="page-16" href="#page-16" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


<span class="h4"><a name="section-4.3.2">4.3.2</a>.  Compressing UDP checksum</span>

   The UDP checksum operation is mandatory with IPv6 [<a href="./rfc2460" title='"Internet Protocol, Version 6 (IPv6) Specification"'>RFC2460</a>] for all
   packets.  For that reason [<a href="./rfc4944" title='"Transmission of IPv6 Packets over IEEE 802.15.4 Networks"'>RFC4944</a>] disallows the compression of the
   UDP checksum.

   With this specification, a compressor in the source transport
   endpoint MAY elide the UDP checksum if it is authorized by the Upper
   Layer.  The compressor SHOULD NOT set the C bit unless it has
   received such authorization.  The Upper Layer SHOULD only provide the
   authorization in the following cases:

   Tunneling:  In this case, 6LoWPAN is deployed as a wireless pseudo-
      fieldbus by tunneling existing field protocols over UDP.  If the
      tunneled PDU possesses its own addressing, security and integrity
      check, the tunneling mechanism MAY authorize to elide the UDP
      checksum in order to save on the encapsulation overhead.
   Upper Layer Message Integrity Check:  In this case, there is some
      other form of integrity check in the UDP payload that covers at
      least the same information as the UDP checksum (pseudo-header,
      data) and has at least the same strength.

   A forwarding node MAY imply authorization from an incoming packet if
   the C bit is set.  A forwarding node that cannot unambiguously derive
   such authorization SHOULD NOT elide the UDP checksum when performing
   6LoWPAN compression.  The forwarding node that expands a 6LoWPAN
   packet with the C bit on MUST compute the UDP checksum on behalf of
   the source node and place that checksum in the restored UDP header as
   specified in the incumbent standards [<a href="./rfc0768" title='"User Datagram Protocol"'>RFC0768</a>], [<a href="./rfc2460" title='"Internet Protocol, Version 6 (IPv6) Specification"'>RFC2460</a>].

   If a 6LoWPAN termination is also the transport endpoint and it
   receives a compressed packet with the C bit set, then it is entitled
   to ignore the UDP checksum process completely.  If the C bit is not
   set, the packet might have been forwarded by an edge router, so this
   is not an indication that the MIC is not present.  If the terminating
   node knows that the message integrity will be validated by the upper
   layer by some state associated to the Service Access Point, it is
   entitled to ignore the checksum operation as if the C bit was set.

<span class="h4"><a name="section-4.3.3">4.3.3</a>.  UDP LOWPAN_NHC Format</span>


                       0   1   2   3   4   5   6   7
                     +---+---+---+---+---+---+---+---+
                     | 1 | 1 | 1 | 1 | 0 | C |   P   |
                     +---+---+---+---+---+---+---+---+





<span class="grey">Hui &amp; Thubert           Expires October 10, 2010               [Page 16]</span>
</pre><pre class='newpage'><a name="page-17" id="page-17" href="#page-17" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


                       Figure 7: UDP Header Encoding

   C: Checksum:
      0: All 16 bits of Checksum are carried in-line.
      1: All 16 bits of Checksum are elided.  The Checksum is recovered
         by recomputing it on the 6LoWPAN termination point.

   P: Ports:
      00:  All 16 bits for both Source Port and Destination Port are
         carried in-line.
      01:  All 16 bits for Source Port are carried in-line.  First 8
         bits of Destination Port is 0xF0 and elided.  The remaining 8
         bits of Destination Port are carried in-line.
      10:  First 8 bits of Source Port are 0xF0 and elided.  The
         remaining 8 bits of Source Port are carried in-line.  All 16
         bits for Destination Port are carried in-line.
      11:  First 12 bits of both Source Port and Destination Port are
         0xF0B and elided.  The remaining 4 bits for each are carried
         in-line.

   Fields carried in-line (in part or in whole) appear in the same order
   as they do in the UDP header format [<a href="./rfc0768" title='"User Datagram Protocol"'>RFC0768</a>].  The UDP Length field
   MUST always be elided and is inferred from lower layers using the
   6LoWPAN Fragmentation header or the IEEE 802.15.4 header.


<span class="h2"><a name="section-5">5</a>.  IANA Considerations</span>

   This document defines a new IPv6 header compression format for
   6LoWPAN networks.  The document allocates the following 32 Dispatch
   type field values for LOWPAN_IPHC:

     01 100000
      through
     01 111111

   This assignment preempts the assignment of 01 111111 for ESC
   [<a href="./rfc4944" title='"Transmission of IPv6 Packets over IEEE 802.15.4 Networks"'>RFC4944</a>], which is possible as no extension bytes have been
   allocated yet that would enable the use of ESC.  Instead, the value:

     01 000000

   is reserved as a replacement value for ESC, to be finally assigned
   with the first assignment of extension bytes.







<span class="grey">Hui &amp; Thubert           Expires October 10, 2010               [Page 17]</span>
</pre><pre class='newpage'><a name="page-18" id="page-18" href="#page-18" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


<span class="h2"><a name="section-6">6</a>.  Security Considerations</span>

   The definition of LOWPAN_IPHC permits the compression of header
   information on communication that could take place in its absence,
   albeit in a less efficient form.  It recognizes that a IEEE 802.15.4
   PAN may have associated with it a number of prefixes through shared
   context.  How the shared context is assigned and managed is beyond
   the scope of this document.

   The overloading of the 0xF0Bx ports increases the risk of getting the
   wrong type of payload and misinterpreting the content compared to
   ports that reserved at IANA.  It is thus recommended that the use of
   those ports be associated with a mechanism such as a Transport Layer
   Security (TLS) Message Integrity Check (MIC) that validates that the
   content is expected and checked for integrity.


<span class="h2"><a name="section-7">7</a>.  Acknowledgements</span>

   Thanks to Julien Abeille, Robert Assimiti, Dominique Barthel, Carsten
   Bormann, Robert Cragie, Stephen Dawson-Haggerty, Mathilde Durvy, Erik
   Nordmark, Christos Polyzois, Shoishi Sakane, Zach Shelby, Tony
   Viscardi, and Jay Werb for useful design consideration and
   implementation feedback.


<span class="h2"><a name="section-8">8</a>.  Changes</span>

   Draft 07:
      - Added section on mapping link-layer addresses to IIDs.
      - Added text on restricting compressed headers to first fragment
      when using fragment headers defined in <a href="./rfc4944#section-5.3">Section&nbsp;5.3 of [RFC4944]</a>.
      - Minor editorial edits.

   Draft 06:
      - Reworked introduction.
      - Added section on updates to [<a href="./rfc4944" title='"Transmission of IPv6 Packets over IEEE 802.15.4 Networks"'>RFC4944</a>].
      - Fixed description of number of bits used for IPHC encoding.
      - Specify M=0 only for non-multicast addresses and M=1 only for
      multicast addresses.
      - Move 128-bit multicast encoding to DAC=0.
      - Redefined ESC dispatch value to 01 000000.
      - Many detailed edits.

   Draft 05:






<span class="grey">Hui &amp; Thubert           Expires October 10, 2010               [Page 18]</span>
</pre><pre class='newpage'><a name="page-19" id="page-19" href="#page-19" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


      - Added LOWPAN_NHC encodings for IPv6 Extension Headers.
      - Specify use of context 0 when CID is 0.
      - Indicate that first 64-bits is link-local prefix padded with
      zeros when link-local prefix is elided.
      - Made prefix-based multicast encoding format more explicit for
      clarity.
      - Changed wording around stateful compression to allow for using
      the in-line bits as an additional index to identify the compressed
      address.
      - Removed support for compressing unspecified address.
      - Full 128-bit addr in-line only in stateless encoding.

   Draft 04:
      - Fixed typos leftover from the changes in 03.
      - Gave more details on UDP checksum compression.
      - Clarify that the context information is out of scope.
      - Added security concern on 0xF0Bx port overloading.

   Draft 03:
      - Decoupled meaning of SAM bits from the destination address.
      - Have separate bit to indicate multicast address compression.
      - More extensive support for multicast address compression,
      including Unicast-Prefix-based Multicast Addresses.

   Draft 02:
      - Updated wording with compression mode to clarify that a
      compression mode does not enforce what kind of destination address
      is being used.  Specifically changed Destination Dependent Field
      to Compression Mode.
      - Specify that the configuration and management of contexts is out
      of scope of this document.

   Draft 01:
      - HC back to 1 byte by default by stealing a few bits from the
      dispatch field.
      - Added better support for multicast address compression.
      - Fixed alignment for UDP port compression.
      - Better support for Traffic Class and Flow Label compression.
      - Pascal joined as an author.


<span class="h2"><a name="section-9">9</a>.  References</span>

<span class="h3"><a name="section-9.1">9.1</a>.  Normative References</span>

   [<a name="ref-RFC0768" id="ref-RFC0768">RFC0768</a>]  Postel, J., "User Datagram Protocol", STD 6, <a href="./rfc768">RFC 768</a>,
              August 1980.




<span class="grey">Hui &amp; Thubert           Expires October 10, 2010               [Page 19]</span>
</pre><pre class='newpage'><a name="page-20" id="page-20" href="#page-20" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


   [<a name="ref-RFC2119" id="ref-RFC2119">RFC2119</a>]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", <a href="./bcp14">BCP 14</a>, <a href="./rfc2119">RFC 2119</a>, March 1997.

   [<a name="ref-RFC2460" id="ref-RFC2460">RFC2460</a>]  Deering, S. and R. Hinden, "Internet Protocol, Version 6
              (IPv6) Specification", <a href="./rfc2460">RFC 2460</a>, December 1998.

   [<a name="ref-RFC2474" id="ref-RFC2474">RFC2474</a>]  Nichols, K., Blake, S., Baker, F., and D. Black,
              "Definition of the Differentiated Services Field (DS
              Field) in the IPv4 and IPv6 Headers", <a href="./rfc2474">RFC 2474</a>,
              December 1998.

   [<a name="ref-RFC3168" id="ref-RFC3168">RFC3168</a>]  Ramakrishnan, K., Floyd, S., and D. Black, "The Addition
              of Explicit Congestion Notification (ECN) to IP",
              <a href="./rfc3168">RFC 3168</a>, September 2001.

   [<a name="ref-RFC3775" id="ref-RFC3775">RFC3775</a>]  Johnson, D., Perkins, C., and J. Arkko, "Mobility Support
              in IPv6", <a href="./rfc3775">RFC 3775</a>, June 2004.

   [<a name="ref-RFC4007" id="ref-RFC4007">RFC4007</a>]  Deering, S., Haberman, B., Jinmei, T., Nordmark, E., and
              B. Zill, "IPv6 Scoped Address Architecture", <a href="./rfc4007">RFC 4007</a>,
              March 2005.

   [<a name="ref-RFC4291" id="ref-RFC4291">RFC4291</a>]  Hinden, R. and S. Deering, "IP Version 6 Addressing
              Architecture", <a href="./rfc4291">RFC 4291</a>, February 2006.

   [<a name="ref-RFC4302" id="ref-RFC4302">RFC4302</a>]  Kent, S., "IP Authentication Header", <a href="./rfc4302">RFC 4302</a>,
              December 2005.

   [<a name="ref-RFC4303" id="ref-RFC4303">RFC4303</a>]  Kent, S., "IP Encapsulating Security Payload (ESP)",
              <a href="./rfc4303">RFC 4303</a>, December 2005.

   [<a name="ref-RFC4944" id="ref-RFC4944">RFC4944</a>]  Montenegro, G., Kushalnagar, N., Hui, J., and D. Culler,
              "Transmission of IPv6 Packets over IEEE 802.15.4
              Networks", <a href="./rfc4944">RFC 4944</a>, September 2007.

<span class="h3"><a name="section-9.2">9.2</a>.  Informative References</span>

   [IEEE 802.15.4]
              IEEE Computer Society, "IEEE Std. 802.15.4-2006",
              October 2006.

   [<a name="ref-RFC3306" id="ref-RFC3306">RFC3306</a>]  Haberman, B. and D. Thaler, "Unicast-Prefix-based IPv6
              Multicast Addresses", <a href="./rfc3306">RFC 3306</a>, August 2002.

   [<a name="ref-RFC3315" id="ref-RFC3315">RFC3315</a>]  Droms, R., Bound, J., Volz, B., Lemon, T., Perkins, C.,
              and M. Carney, "Dynamic Host Configuration Protocol for
              IPv6 (DHCPv6)", <a href="./rfc3315">RFC 3315</a>, July 2003.




<span class="grey">Hui &amp; Thubert           Expires October 10, 2010               [Page 20]</span>
</pre><pre class='newpage'><a name="page-21" id="page-21" href="#page-21" class="invisible"> </a>
<span class="grey">Internet-Draft    6LoWPAN Compression of IPv6 Datagrams       April 2010</span>


   [<a name="ref-RFC3956" id="ref-RFC3956">RFC3956</a>]  Savola, P. and B. Haberman, "Embedding the Rendezvous
              Point (RP) Address in an IPv6 Multicast Address",
              <a href="./rfc3956">RFC 3956</a>, November 2004.

   [<a name="ref-RFC4861" id="ref-RFC4861">RFC4861</a>]  Narten, T., Nordmark, E., Simpson, W., and H. Soliman,
              "Neighbor Discovery for IP version 6 (IPv6)", <a href="./rfc4861">RFC 4861</a>,
              September 2007.


Authors' Addresses

   Jonathan W. Hui (editor)
   Arch Rock Corporation
   501 2nd St. Ste. 410
   San Francisco, California  94107
   USA

   Phone: +415 692 0828
   Email: jhui@archrock.com


   Pascal Thubert
   Cisco Systems
   Village d'Entreprises Green Side
   400, Avenue de Roumanille
   Batiment T3
   Biot - Sophia Antipolis  06410
   FRANCE

   Phone: +33 4 97 23 26 34
   Email: pthubert@cisco.com




















Hui &amp; Thubert           Expires October 10, 2010               [Page 21]
</pre><pre class='newpage'>


</pre><br />
<span class="noprint"><small><small>Html markup produced by rfcmarkup 1.89, available from
<a href="http://tools.ietf.org/tools/rfcmarkup/">http://tools.ietf.org/tools/rfcmarkup/</a>
</small></small></span>
</body></html>
